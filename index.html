<?php
session_start();

/* ================= DATABASE CONNECTION ================= */
$host = "localhost";
$port = "3309";
$user = "root";
$pass = "";
$db   = "student_management";

$conn = new mysqli($host, $user, $pass, $db, $port);
if ($conn->connect_error) die("Connection failed: " . $conn->connect_error);

/* ================= REGISTER ================= */
if (isset($_POST['action']) && $_POST['action'] === 'register') {
    $username = trim($_POST['username']);
    $password = trim($_POST['password']);
    $confirm  = trim($_POST['confirm']);

    if ($username === '' || $password === '' || $confirm === '') {
        $error = "All fields are required!";
    } elseif ($password !== $confirm) {
        $error = "Passwords do not match!";
    } else {
        $check = $conn->query("SELECT * FROM user WHERE username='$username'");
        if ($check->num_rows > 0) {
            $error = "Username already exists!";
        } else {
            $hashed = md5($password);
            $conn->query("INSERT INTO user (username, password) VALUES ('$username', '$hashed')");
            $success = "Registration successful! You can now login.";
        }
    }
}

/* ================= LOGIN ================= */
if (isset($_POST['action']) && $_POST['action'] === 'login') {
    $username = $_POST['username'];
    $password = md5($_POST['password']);
    $result = $conn->query("SELECT * FROM user WHERE username='$username' AND password='$password'");

    if ($result->num_rows > 0) {
        $_SESSION['username'] = $username;
        header("Location: index.php");
        exit;
    } else {
        $error = "Invalid username or password!";
    }
}

/* ================= LOGOUT ================= */
if (isset($_POST['action']) && $_POST['action'] === 'logout') {
    session_destroy();
    header("Location: index.php");
    exit;
}

/* ================= CRUD ================= */
if (isset($_SESSION['username']) && $_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $action = $_POST['action'];
    if (in_array($action, ['add', 'update', 'delete'])) {
        $id = $_POST['id'] ?? '';
        $name = $_POST['name'] ?? '';
        $email = $_POST['email'] ?? '';
        $course = $_POST['course'] ?? '';
        $age = $_POST['age'] ?? '';

        if ($action == 'add') {
            $conn->query("INSERT INTO students (name,email,course,age) VALUES ('$name','$email','$course','$age')");
        } elseif ($action == 'update') {
            $conn->query("UPDATE students SET name='$name', email='$email', course='$course', age='$age' WHERE id='$id'");
        } elseif ($action == 'delete') {
            $conn->query("DELETE FROM students WHERE id='$id'");
        }

        header("Location: index.php");
        exit;
    }
}

$students = $conn->query("SELECT * FROM students ORDER BY id DESC");
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Management System</title>

<!-- Bootstrap + Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('galaxy.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;
    min-height: 100vh;
    position: relative;
}
body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(0,17,26,0.85), rgba(0,31,51,0.8), rgba(0,51,77,0.8));
    backdrop-filter: blur(10px);
    z-index: -1;
}

/* Rocket Animation */
@keyframes floatRocket { 0%,100%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-6px) rotate(6deg);} }
@keyframes glowPulse { 0%,100%{filter:drop-shadow(0 0 6px #00FA9A);}50%{filter:drop-shadow(0 0 14px #00FA9A);} }

/* Logo Header */
.logo-header { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:25px; }
.logo-header i { font-size:2.3rem; color:#00FA9A; animation:floatRocket 3s ease-in-out infinite, glowPulse 2s ease-in-out infinite; }
.logo-header h1 { font-size:1.9rem; font-weight:700; color:#7FFFD4; text-shadow:0 0 12px rgba(0,255,200,0.5); }

/* Auth Container */
.container-auth { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,40,0.75); padding:40px 35px; border-radius:20px; width:380px; max-width:90%; text-align:center; border:1px solid rgba(20,255,200,0.3); box-shadow:0 0 30px rgba(0,255,200,0.2);}
h2 { color:#7FFFD4; font-size:2rem; margin-bottom:20px; }
.input-group { position:relative; }
.input-group i.fa-eye, .input-group i.fa-eye-slash { position:absolute; top:50%; right:14px; transform:translateY(-50%); cursor:pointer; color:#7FFFD4; }
.container-auth input { width:100%; padding:12px 14px; border-radius:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; margin-bottom:15px; }
.container-auth button { width:100%; padding:12px 0; border-radius:8px; font-weight:600; background:#00FA9A; color:#002020; border:none; transition:0.3s ease; }
.container-auth button:hover { background:#7FFFD4; transform:scale(1.03); }
.toggle { color:#7FFFD4; margin-top:12px; cursor:pointer; text-decoration:underline; }

/* Dashboard */
.dashboard { width:95%; max-width:1100px; margin:80px auto; background:rgba(0,0,30,0.85); border-radius:20px; padding:40px; border:1px solid rgba(0,255,200,0.2); box-shadow:0 0 25px rgba(0,255,200,0.3);}
.dashboard-header { display:flex; justify-content:space-between; align-items:center;}
.logout-btn { background:#ff4d4d; color:white; border:none; border-radius:8px; padding:8px 16px; transition:0.3s; }
.logout-btn:hover { background:#ff7373; }

.student-form, .table-container { margin-top:25px; }
.student-form input { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; }
.student-form button { background:#00FA9A; color:#002020; font-weight:600; border-radius:8px; border:none; transition:0.3s; }
.student-form button:hover { background:#7FFFD4; transform:scale(1.05); }

table { color:white; background:rgba(255,255,255,0.05); border-radius:12px; overflow:hidden; width:100%; }
thead { background: rgba(0,255,200,0.2); }
.table-search { margin-bottom:12px; }
.table-search input { width:100%; padding:10px; border-radius:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; }
</style>
</head>

<body>

<?php if (!isset($_SESSION['username'])): ?>
<div class="container-auth">
    <div class="logo-header">
        <i class="fa-solid fa-rocket"></i>
        <h1>Student Management System</h1>
    </div>

    <?php if (!empty($error)) echo "<div class='text-red-500 mb-2'>$error</div>"; ?>
    <?php if (!empty($success)) echo "<div class='text-green-400 mb-2'>$success</div>"; ?>

    <form id="loginForm" method="post">
        <input type="hidden" name="action" value="login">
        <input type="text" name="username" placeholder="Username" required>
        <div class="input-group">
            <input type="password" name="password" id="loginPassword" placeholder="Password" required>
            <i class="fa fa-eye" id="toggleLoginPassword"></i>
        </div>
        <button type="submit">Login</button>
    </form>

    <form id="registerForm" method="post" class="hidden mt-2">
        <input type="hidden" name="action" value="register">
        <input type="text" name="username" placeholder="Username" required>
        <div class="input-group">
            <input type="password" name="password" id="registerPassword" placeholder="Password" required>
            <i class="fa fa-eye" id="toggleRegisterPassword"></i>
        </div>
        <div class="input-group">
            <input type="password" name="confirm" id="confirmPassword" placeholder="Confirm Password" required>
            <i class="fa fa-eye" id="toggleConfirmPassword"></i>
        </div>
        <button type="submit">Register</button>
    </form>

    <div class="toggle" id="toggleForm">Switch to Register</div>
</div>

<script>
const toggleForm = document.getElementById('toggleForm');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
toggleForm.addEventListener('click', () => {
    loginForm.classList.toggle('hidden');
    registerForm.classList.toggle('hidden');
    toggleForm.innerText = loginForm.classList.contains('hidden') ? 'Switch to Login' : 'Switch to Register';
});
function setupPasswordToggle(toggleId, inputId) {
    const toggleIcon = document.getElementById(toggleId);
    const input = document.getElementById(inputId);
    toggleIcon.addEventListener('click', () => {
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        toggleIcon.classList.toggle('fa-eye');
        toggleIcon.classList.toggle('fa-eye-slash');
    });
}
setupPasswordToggle('toggleLoginPassword', 'loginPassword');
setupPasswordToggle('toggleRegisterPassword', 'registerPassword');
setupPasswordToggle('toggleConfirmPassword', 'confirmPassword');
</script>

<?php else: ?>
<div class="dashboard">
    <div class="dashboard-header">
        <div class="logo-header">
            <i class="fa-solid fa-rocket"></i>
            <h1>Student Management System</h1>
        </div>
        <form method="post">
            <input type="hidden" name="action" value="logout">
            <button class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </form>
    </div>

    <!-- Add / Edit Student Form -->
    <form id="studentForm" method="post" class="student-form grid grid-cols-1 md:grid-cols-5 gap-3">
        <input type="hidden" name="action" id="formAction" value="add">
        <input type="hidden" name="id" id="studentId">
        <input type="text" name="name" id="name" placeholder="Full Name" required>
        <input type="email" name="email" id="email" placeholder="Email" required>
        <input type="text" name="course" id="course" placeholder="Course" required>
        <input type="number" name="age" id="age" placeholder="Age" required>
        <button type="submit" id="submitBtn" class="col-span-1 md:col-span-5">
            <i class="fa-solid fa-plus"></i> Add
        </button>
    </form>

    <!-- Search Bar -->
    <div class="table-search">
        <input type="text" id="searchInput" placeholder="Search students...">
    </div>

    <!-- Students Table -->
    <div class="table-container mt-2">
        <table class="table table-dark table-hover align-middle">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Course</th>
                    <th>Age</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php $count = 1; while ($row = $students->fetch_assoc()): ?>
                <tr>
                    <td><?= $count++; ?></td>
                    <td><?= htmlspecialchars($row['name']); ?></td>
                    <td><?= htmlspecialchars($row['email']); ?></td>
                    <td><?= htmlspecialchars($row['course']); ?></td>
                    <td><?= $row['age']; ?></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning edit-btn"
                            data-id="<?= $row['id']; ?>"
                            data-name="<?= htmlspecialchars($row['name']); ?>"
                            data-email="<?= htmlspecialchars($row['email']); ?>"
                            data-course="<?= htmlspecialchars($row['course']); ?>"
                            data-age="<?= $row['age']; ?>">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <form method="post" class="d-inline">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="id" value="<?= $row['id']; ?>">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                <?php endwhile; ?>
            </tbody>
        </table>
    </div>
</div>

<script>
// ===== EDIT BUTTON FUNCTION =====
document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', () => {
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const email = button.getAttribute('data-email');
        const course = button.getAttribute('data-course');
        const age = button.getAttribute('data-age');

        document.getElementById('studentId').value = id;
        document.getElementById('name').value = name;
        document.getElementById('email').value = email;
        document.getElementById('course').value = course;
        document.getElementById('age').value = age;

        document.getElementById('formAction').value = 'update';
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Update';
        btn.style.background = '#FFD700';
    });
});

// ===== SEARCH FUNCTION =====
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('keyup', () => {
    const filter = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('table tbody tr');
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
});
</script>

<?php endif; ?>
</body>
</html>
