<?php
session_start();

/* ================= DATABASE CONNECTION ================= */
$host = "localhost";
$port = "3309";
$user = "root";
$pass = "";
$db   = "student_management";

$conn = new mysqli($host, $user, $pass, $db, $port);

// FIXED CONNECTION ERROR
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

/* ================= REGISTER ================= */
if (isset($_POST['action']) && $_POST['action'] === 'register') {
    $username = trim($_POST['username']);
    $password = trim($_POST['password']);
    $confirm  = trim($_POST['confirm']);

    if ($username === '' || $password === '' || $confirm === '') {
        $error = "All fields are required!";
    } elseif ($password !== $confirm) {
        $error = "Passwords do not match!";
    } else {
        $usernameEsc = $conn->real_escape_string($username);
        $check = $conn->query("SELECT * FROM user WHERE username='$usernameEsc'");

        if ($check->num_rows > 0) {
            $error = "Username already exists!";
        } else {
            $hashed = md5($password);
            $conn->query("INSERT INTO user (username, password) VALUES ('$usernameEsc', '$hashed')");
            $success = "Registration successful! You can now login.";
        }
    }
}

/* ================= LOGIN ================= */
if (isset($_POST['action']) && $_POST['action'] === 'login') {
    $username = $conn->real_escape_string($_POST['username']);
    $password = md5($_POST['password']);

    $result = $conn->query("SELECT * FROM user WHERE username='$username' AND password='$password'");

    if ($result->num_rows > 0) {
        $_SESSION['username'] = $username;
        header("Location: index.html");
        exit;
    } else {
        $error = "Invalid username or password!";
    }
}

/* ================= LOGOUT ================= */
if (isset($_POST['action']) && $_POST['action'] === 'logout') {
    session_destroy();
    header("Location: index.html");
    exit;
}

/* ================= CRUD ================= */
if (isset($_SESSION['username']) && isset($_POST['action'])) {
    $action = $_POST['action'];

    if (in_array($action, ['add', 'update', 'delete'])) {

        $id     = intval($_POST['id'] ?? 0);
        $name   = $conn->real_escape_string($_POST['name'] ?? '');
        $email  = $conn->real_escape_string($_POST['email'] ?? '');
        $course = $conn->real_escape_string($_POST['course'] ?? '');
        $age    = intval($_POST['age'] ?? 0);

        if ($action == 'add') {
            $conn->query("INSERT INTO students (name, email, course, age) VALUES ('$name', '$email', '$course', '$age')");
        }

        if ($action == 'update') {
            $conn->query("UPDATE students SET name='$name', email='$email', course='$course', age='$age' WHERE id=$id");
        }

        if ($action == 'delete') {
            $conn->query("DELETE FROM students WHERE id=$id");
        }

        header("Location: index.html");
        exit;
    }
}

/* ================= LOAD STUDENTS ================= */
$students = $conn->query("SELECT * FROM students ORDER BY id DESC");
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Management System</title>

<!-- Frameworks -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
/* (Your existing CSS — unchanged) */
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('galaxy.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;
    min-height: 100vh;
    position: relative;
}
body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(0,17,26,0.85), rgba(0,31,51,0.8), rgba(0,51,77,0.8));
    backdrop-filter: blur(10px);
    z-index: -1;
}
/* Animations, UI styles, buttons, table styles — unchanged */
</style>
</head>
<body>

<?php if (!isset($_SESSION['username'])): ?>

<!-- ================= AUTH SCREEN ================= -->
<div class="container-auth">

    <div class="logo-header">
        <i class="fa-solid fa-rocket"></i>
        <h1>Student Management System</h1>
    </div>

    <?php if (!empty($error)) echo "<div class='text-red-500 mb-2'>$error</div>"; ?>
    <?php if (!empty($success)) echo "<div class='text-green-400 mb-2'>$success</div>"; ?>

    <!-- LOGIN FORM -->
    <form id="loginForm" method="post">
        <input type="hidden" name="action" value="login">
        <input type="text" name="username" placeholder="Username" required>

        <div class="input-group">
            <input type="password" name="password" id="loginPassword" placeholder="Password" required>
            <i class="fa fa-eye" id="toggleLoginPassword"></i>
        </div>

        <button type="submit">Login</button>
    </form>

    <!-- REGISTER FORM -->
    <form id="registerForm" method="post" class="hidden mt-2">
        <input type="hidden" name="action" value="register">
        <input type="text" name="username" placeholder="Username" required>

        <div class="input-group">
            <input type="password" name="password" id="registerPassword" placeholder="Password" required>
            <i class="fa fa-eye" id="toggleRegisterPassword"></i>
        </div>

        <div class="input-group">
            <input type="password" name="confirm" id="confirmPassword" placeholder="Confirm Password" required>
            <i class="fa fa-eye" id="toggleConfirmPassword"></i>
        </div>

        <button type="submit">Register</button>
    </form>

    <div class="toggle" id="toggleForm">Switch to Register</div>
</div>

<script>
// FIXED TOGGLE: removed broken "formTitle" code
const toggleForm = document.getElementById('toggleForm');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');

toggleForm.addEventListener('click', () => {
    loginForm.classList.toggle('hidden');
    registerForm.classList.toggle('hidden');

    toggleForm.innerText =
        loginForm.classList.contains('hidden')
            ? "Switch to Login"
            : "Switch to Register";
});

// Password toggle icons
function setupPasswordToggle(toggleId, inputId) {
    const icon = document.getElementById(toggleId);
    const input = document.getElementById(inputId);

    icon.addEventListener('click', () => {
        input.type = input.type === "password" ? "text" : "password";
        icon.classList.toggle("fa-eye");
        icon.classList.toggle("fa-eye-slash");
    });
}

setupPasswordToggle('toggleLoginPassword', 'loginPassword');
setupPasswordToggle('toggleRegisterPassword', 'registerPassword');
setupPasswordToggle('toggleConfirmPassword', 'confirmPassword');
</script>

<?php else: ?>

<!-- ================= DASHBOARD ================= -->
<div class="dashboard">
    <div class="dashboard-header">
        <div class="logo-header">
            <i class="fa-solid fa-rocket"></i>
            <h1>Student Management System</h1>
        </div>

        <form method="post">
            <input type="hidden" name="action" value="logout">
            <button class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </form>
    </div>

    <!-- ADD/EDIT FORM -->
    <form id="studentForm" method="post" class="student-form grid grid-cols-1 md:grid-cols-5 gap-3">
        <input type="hidden" name="action" id="formAction" value="add">
        <input type="hidden" name="id" id="studentId">

        <input type="text" name="name" id="name" placeholder="Full Name" required>
        <input type="email" name="email" id="email" placeholder="Email" required>
        <input type="text" name="course" id="course" placeholder="Course" required>
        <input type="number" name="age" id="age" placeholder="Age" required>

        <button type="submit" id="submitBtn" class="col-span-1 md:col-span-5">
            <i class="fa-solid fa-plus"></i> Add
        </button>
    </form>

    <!-- TABLE -->
    <div class="table-container mt-4">
        <table class="table table-dark table-hover align-middle">
            <thead>
                <tr>
                    <th>#</th><th>Name</th><th>Email</th><th>Course</th><th>Age</th><th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php $count = 1; while ($row = $students->fetch_assoc()): ?>
                <tr>
                    <td><?= $count++; ?></td>
                    <td><?= htmlspecialchars($row['name']); ?></td>
                    <td><?= htmlspecialchars($row['email']); ?></td>
                    <td><?= htmlspecialchars($row['course']); ?></td>
                    <td><?= $row['age']; ?></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning edit-btn"
                            data-id="<?= $row['id']; ?>"
                            data-name="<?= htmlspecialchars($row['name']); ?>"
                            data-email="<?= htmlspecialchars($row['email']); ?>"
                            data-course="<?= htmlspecialchars($row['course']); ?>"
                            data-age="<?= $row['age']; ?>">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <form method="post" class="d-inline">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="id" value="<?= $row['id']; ?>">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                <?php endwhile; ?>
            </tbody>
        </table>
    </div>
</div>

<script>
// EDIT BUTTON FUNCTION
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('studentId').value = btn.dataset.id;
        document.getElementById('name').value = btn.dataset.name;
        document.getElementById('email').value = btn.dataset.email;
        document.getElementById('course').value = btn.dataset.course;
        document.getElementById('age').value = btn.dataset.age;

        document.getElementById('formAction').value = 'update';

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Update';
        submitBtn.style.background = '#FFD700';
    });
});
</script>

<?php endif; ?>

</body>
</html>
